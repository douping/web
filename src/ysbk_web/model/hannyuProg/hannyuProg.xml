<?xml version="1.0" encoding="Shift_JIS" ?>  
  
<!DOCTYPE sqlMap        
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"        
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap>
	<typeAlias alias="HannyuProgEntity" type="ysbk_web.model.hannyuProg.HannyuProgEntity" />
	<!-- ”À“üi’»ˆê——Žæ“¾ -->
	<select id="findHannyuProg" parameterClass="java.util.HashMap"
		resultClass="HannyuProgEntity">
		SELECT
		DATA.HAN_YMD,BINMA.KANRI_KOJO,BINMA.S_KYOTEN,BINMA.BIN_NO,
		DATA.TOKUSYA_KB,DATA.TOKUSYA_KAI,DATA.BIN_ID,BINMA.BIN_NM,
		DECODE(DATA.HANJOU_FG,'4','1',DECODE(DATA.HANJOU_FG,'5','1',DATA.HANJOU_FG))
		AS HANJOU_FG,
		SUM(DATA.SIJI_HAKO) AS SIJI_HAKO,SUM(DATA.HAN_HAKO) AS
		HAN_HAKO,DATA.HANJOU_FG AS HANJOU_KEY
		FROM
		(
		SELECT
		HIN.TK_HIN,HIN.SYUYO_SU,HIN.HAN_YMD,HIN.BIN_ID,HIN.TOKUSYA_KB,HIN.TOKUSYA_KAI,
		BIN.HANJOU_FG,SUM(HIN.SIJI_HAKO) AS SIJI_HAKO,SUM(HIN.HAN_HAKO) AS
		HAN_HAKO
		FROM TB_HANBIN_JO BIN,TB_HANHIN_JO HIN
		WHERE BIN.BIN_ID =
		HIN.BIN_ID AND BIN.HAN_YMD = HIN.HAN_YMD
		AND BIN.TOKUSYA_KB =
		HIN.TOKUSYA_KB AND BIN.TOKUSYA_KAI = HIN.TOKUSYA_KAI
		GROUP BY
		HIN.TK_HIN,HIN.SYUYO_SU,HIN.HAN_YMD,HIN.BIN_ID,HIN.TOKUSYA_KB,
		HIN.TOKUSYA_KAI,BIN.HANJOU_FG
		UNION ALL
		SELECT
		HAN.TK_HIN,HAN.SYUYO_SU,HAN.HAN_YMD,HAN.BIN_ID,HAN.TOKUSYA_KB,HAN.TOKUSYA_KAI,
		BIN.HANJOU_FG,SUM(HAN.HAN_HAKO) AS SIJI_HAKO,SUM(HAN.HAN_HAKO) AS
		HAN_HAKO
		FROM TB_HANBIN_JO BIN,TB_HANNYU_RI HAN
		WHERE BIN.BIN_ID =
		HAN.BIN_ID AND BIN.HAN_YMD = HAN.HAN_YMD
		AND BIN.TOKUSYA_KB =
		HAN.TOKUSYA_KB AND BIN.TOKUSYA_KAI = HAN.TOKUSYA_KAI
		GROUP BY
		HAN.TK_HIN,HAN.SYUYO_SU,HAN.HAN_YMD,HAN.BIN_ID,HAN.TOKUSYA_KB,
		HAN.TOKUSYA_KAI,BIN.HANJOU_FG
		) DATA,
		(
		SELECT
		TK_HIN,SYUYO_SU,KANRI_KOJO,S_KYOTEN FROM TB_HINBAN_MA
		GROUP BY
		TK_HIN,SYUYO_SU,KANRI_KOJO,S_KYOTEN
		) HINMA,
		TB_HBINNM_MA BINMA
		WHERE
		DATA.TK_HIN = HINMA.TK_HIN AND DATA.SYUYO_SU = HINMA.SYUYO_SU
		AND
		DATA.BIN_ID = BINMA.BIN_ID AND DATA.HANJOU_FG NOT IN ('7','8')
		<isNotNull property="siire">
			AND HINMA.KANRI_KOJO = #siire#
		</isNotNull>
		<isNotNull property="han_ymd">
			AND DATA.HAN_YMD = #han_ymd#
		</isNotNull>
		GROUP BY DATA.HAN_YMD,BINMA.KANRI_KOJO,BINMA.S_KYOTEN,BINMA.BIN_NO,
		DATA.TOKUSYA_KB,DATA.TOKUSYA_KAI,DATA.BIN_ID,BINMA.BIN_NM,DATA.HANJOU_FG
		ORDER BY DATA.HAN_YMD,BINMA.KANRI_KOJO,BINMA.S_KYOTEN,BINMA.BIN_NO
	</select>
</sqlMap>